<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sidekick Desktop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-screen">
  <div id="root" class="h-full"></div>

<script type="text/babel">
const { useState, useEffect, useContext, createContext } = React;
const API_BASE = 'http://localhost:5000';

const AppContext = createContext();

function AppProvider({ children }) {
  const [project, setProjectState] = useState(localStorage.getItem('currentProject'));
  const [projects, setProjects] = useState(JSON.parse(localStorage.getItem('projects') || '[]'));
  const [jiraConfig, setJiraConfigState] = useState(JSON.parse(localStorage.getItem('jiraConfig') || '{}'));
  const [configLoading, setConfigLoading] = useState(false);

  const saveProjects = (list) => localStorage.setItem('projects', JSON.stringify(list));

  const selectProject = async (name) => {
    setProjectState(name);
    localStorage.setItem('currentProject', name);
    try { await axios.post(`${API_BASE}/set-project`, { project: name }); } catch (e) { console.error(e); }
  };

  const createProject = async (name) => {
    const newProjects = [...projects, name];
    setProjects(newProjects);
    saveProjects(newProjects);
    await selectProject(name);
  };

  const resetProject = () => {
    setProjectState(null);
    localStorage.removeItem('currentProject');
  };

  const saveConfig = async (conf) => {
    setConfigLoading(true);
    setJiraConfigState(conf);
    localStorage.setItem('jiraConfig', JSON.stringify(conf));
    try { await axios.post(`${API_BASE}/set-jira-config`, conf); } catch (e) { console.error(e); }
    setConfigLoading(false);
  };

  return (
    <AppContext.Provider value={{ project, projects, createProject, selectProject, resetProject, jiraConfig, saveConfig, configLoading }}>
      {children}
    </AppContext.Provider>
  );
}

function WelcomeScreen({ onCreate, onSelect, projects }) {
  const [creating, setCreating] = useState(false);
  const [selecting, setSelecting] = useState(false);
  const [name, setName] = useState('');
  const [selected, setSelected] = useState(projects[0] || '');

  const handleCreate = () => {
    const n = name.trim();
    if (n) {
      onCreate(n);
      setName('');
      setCreating(false);
    }
  };

  const handleSelect = () => {
    if (selected) {
      onSelect(selected);
      setSelecting(false);
    }
  };

  return (
    <div className="flex flex-col items-center justify-center h-full bg-gray-100">
      <h1 className="text-4xl font-bold mb-8">Welcome to Sidekick</h1>
      {!creating && !selecting && (
        <div className="space-x-4">
          <button className="px-4 py-2 bg-blue-500 text-white rounded" onClick={() => setSelecting(true)}>Select Existing Project</button>
          <button className="px-4 py-2 bg-green-500 text-white rounded" onClick={() => setCreating(true)}>Create New Project</button>
        </div>
      )}
      {creating && (
        <div className="space-x-2">
          <input className="border p-1" placeholder="Project name" value={name} onChange={e => setName(e.target.value)} />
          <button className="px-3 py-1 bg-green-500 text-white rounded" onClick={handleCreate}>Save</button>
          <button className="px-3 py-1 bg-gray-300 rounded" onClick={() => { setCreating(false); setName(''); }}>Cancel</button>
        </div>
      )}
      {selecting && (
        <div className="space-x-2">
          <select className="border p-1" value={selected} onChange={e => setSelected(e.target.value)}>
            {projects.map(p => <option key={p} value={p}>{p}</option>)}
          </select>
          <button className="px-3 py-1 bg-blue-500 text-white rounded" onClick={handleSelect}>Select</button>
          <button className="px-3 py-1 bg-gray-300 rounded" onClick={() => setSelecting(false)}>Cancel</button>
        </div>
      )}
    </div>
  );
}

function Sidebar({ project, onChangeProject }) {
  return (
    <div className="w-64 bg-gray-800 text-white p-4 flex flex-col">
      <div className="text-xl font-semibold mb-4">Project: {project}</div>
      <button className="mb-2 px-2 py-1 bg-gray-700 rounded" onClick={onChangeProject}>Change Project</button>
      <button className="px-2 py-1 bg-gray-700 rounded">Settings</button>
    </div>
  );
}

function JiraSetupForm({ config, onSave, loading }) {
  const [form, setForm] = useState(config);
  useEffect(() => setForm(config), [config]);
  const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });
  const handleSubmit = () => {
    onSave(form);
  };
  return (
    <div className="border rounded p-4 flex flex-col w-full md:w-1/3">
      <h2 className="text-xl mb-2">ðŸ›  Jira Setup</h2>
      <input className="border p-1 mb-2" placeholder="Jira domain" name="domain" value={form.domain || ''} onChange={handleChange} />
      <input className="border p-1 mb-2" placeholder="API token" name="token" value={form.token || ''} onChange={handleChange} />
      <input className="border p-1 mb-2" placeholder="Email" name="email" value={form.email || ''} onChange={handleChange} />
      <input className="border p-1 mb-2" placeholder="Project key" name="projectKey" value={form.projectKey || ''} onChange={handleChange} />
      <input className="border p-1 mb-2" placeholder="Default assignee" name="assignee" value={form.assignee || ''} onChange={handleChange} />
      <button className="bg-blue-500 text-white px-2 py-1 rounded mt-auto" onClick={handleSubmit} disabled={loading}>
        {loading ? 'Saving...' : 'Save Config'}
      </button>
    </div>
  );
}

function ChatPanel({ history, onSend, loading }) {
  const [input, setInput] = useState('');
  const send = () => {
    if (!input.trim()) return;
    onSend(input);
    setInput('');
  };
  return (
    <div className="flex flex-col flex-1 border rounded p-4">
      <h2 className="text-xl mb-2">ðŸ’¬ Chat</h2>
      <div className="flex-1 overflow-y-auto mb-2 space-y-2">
        {history.map((msg, i) => (
          <div key={i} className={`p-2 rounded ${msg.sender === 'user' ? 'bg-blue-100 text-right' : 'bg-gray-100'}`}>{msg.text}</div>
        ))}
      </div>
      <div className="flex">
        <input className="flex-1 border p-2 rounded-l" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if(e.key === 'Enter'){e.preventDefault(); send(); } }} placeholder="Ask something..." />
        <button className="bg-blue-500 text-white px-4 rounded-r" onClick={send} disabled={loading}>{loading ? '...': 'Send'}</button>
      </div>
    </div>
  );
}

function ProjectDashboard({ project, jiraConfig, onSaveConfig, chatHistory, onSendChat, onChangeProject, chatLoading, configLoading }) {
  return (
    <div className="flex h-full">
      <Sidebar project={project} onChangeProject={onChangeProject} />
      <div className="flex flex-col flex-1 p-4 gap-4">
        <div className="flex flex-col md:flex-row gap-4 h-full">
          <JiraSetupForm config={jiraConfig} onSave={onSaveConfig} loading={configLoading} />
          <ChatPanel history={chatHistory} onSend={onSendChat} loading={chatLoading} />
        </div>
      </div>
    </div>
  );
}

function App() {
  const { project, projects, createProject, selectProject, resetProject, jiraConfig, saveConfig, configLoading } = useContext(AppContext);
  const [chatHistory, setChatHistory] = useState([]);
  const [chatLoading, setChatLoading] = useState(false);

  const handleCreateProject = async (name) => {
    if (name) await createProject(name);
  };

  const handleSelectProject = async (name) => {
    if (name) await selectProject(name);
  };

  const handleChangeProject = () => {
    resetProject();
  };

  const handleSaveConfig = async (conf) => {
    await saveConfig(conf);
  };

  const handleSendChat = async (text) => {
    const newHistory = [...chatHistory, { sender: 'user', text }];
    setChatHistory(newHistory);
    setChatLoading(true);
    try {
      const res = await axios.post(`${API_BASE}/run-notes`, { notes: text, project });
      const aiText = res.data.response || res.data.result || JSON.stringify(res.data);
      setChatHistory([...newHistory, { sender: 'ai', text: aiText }]);
    } catch (err) {
      setChatHistory([...newHistory, { sender: 'ai', text: 'Error contacting backend' }]);
    }
    setChatLoading(false);
  };

  if (!project) {
    return <WelcomeScreen onCreate={handleCreateProject} onSelect={handleSelectProject} projects={projects} />;
  }

  return (
    <ProjectDashboard
      project={project}
      jiraConfig={jiraConfig}
      onSaveConfig={handleSaveConfig}
      chatHistory={chatHistory}
      onSendChat={handleSendChat}
      onChangeProject={handleChangeProject}
      chatLoading={chatLoading}
      configLoading={configLoading}
    />
  );
}

ReactDOM.render(<AppProvider><App /></AppProvider>, document.getElementById('root'));
</script>
</body>
</html>
